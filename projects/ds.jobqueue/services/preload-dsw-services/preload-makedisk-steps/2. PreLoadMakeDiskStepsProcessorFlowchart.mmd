flowchart LR
    %% Nodes
    Start(["Start"]):::start
    OrderSteps["PreLoadMakeDiscSteps: OrderBy(StepId)"]:::step
    GetInitStep["PreLoadMakeDiscSteps: Get Step1 - InitializeStep"]:::step
    RunInitStep["PreLoadMakeDiscStep: RunAsync(state) (Step1)\n(Note: Step updates state)"]:::action
    CheckValid{state.Result.CodeType\n== Valid?}:::decision
    ForEachStep{"For each Step in Ordered Steps (excluding Step1)"}:::decision
    CheckSkip{state.SkipStep\n== step.StepId?}:::decision
    RunStep["PreLoadMakeDiscStep: RunAsync(state)\n(Note: Each step updates state)"]:::action
    BreakStep{state.BreakStep?}:::decision
    End(["End"]):::endnode
    Exception["Exception Occurred"]:::exception
    LogError["Logger: LogError"]:::logger
    SetManual["Set state.Result.CodeType = Manual\nSet state.Result.ErrorCode = PreloadFailed"]:::manual
    EvaluateManual["QueueMakeDiscManualSubmissionService:\nEvaluateManualSubmission(state)"]:::service
    GetValidation["DataloaderService: GetValidationLookupAsync\n(state.Result.ErrorCode)"]:::service
    SetErrorDesc["Set state.Result.ErrorDescription"]:::action

    %% Main flow
    Start --> OrderSteps --> GetInitStep --> RunInitStep --> CheckValid
    CheckValid -- Yes --> ForEachStep
    CheckValid -- No --> GetValidation
    ForEachStep --> CheckSkip
    CheckSkip -- Yes (Skip) --> ForEachStep
    CheckSkip -- No (Run) --> RunStep --> BreakStep
    BreakStep -- No --> ForEachStep
    BreakStep -- Yes --> GetValidation
    Start -.->|Exception| Exception

    %% Exception flow
    Exception -.-> LogError -.-> SetManual -.-> EvaluateManual -.-> GetValidation

    %% After steps or exception
    GetValidation --> SetErrorDesc --> End

    %% Styling (readable text)
    classDef start fill:#e3f6fc,stroke:#007acc,stroke-width:2px,color:#00334d,font-weight:bold;
    classDef endnode fill:#d4f8e8,stroke:#009966,stroke-width:2px,color:#003d26,font-weight:bold;
    classDef step fill:#f3e8ff,stroke:#6c63ff,stroke-width:2px,color:#2d186c;
    classDef action fill:#fffbe6,stroke:#ffb300,stroke-width:2px,color:#665200;
    classDef service fill:#ffe0e6,stroke:#e75480,stroke-width:2px,color:#7a2941;
    classDef decision fill:#fff6d6,stroke:#b7950b,stroke-width:2px,color:#665200;
    classDef exception fill:#f8d7da,stroke:#d9534f,stroke-width:2px,stroke-dasharray: 5 5,color:#7a2323;
    classDef logger fill:#d1ecf1,stroke:#0c5460,stroke-width:2px,stroke-dasharray: 5 5,color:#00333a;
    classDef manual fill:#fbeee6,stroke:#e67e22,stroke-width:2px,stroke-dasharray: 5 5,color:#7a4a0a;
    class Start start;
    class End endnode;
    class OrderSteps,GetInitStep step;
    class RunInitStep,RunStep,SetErrorDesc action;
    class GetValidation,EvaluateManual service;
    class ForEachStep,BreakStep,CheckValid,CheckSkip decision;
    class Exception exception;
    class LogError logger;
    class SetManual manual;
